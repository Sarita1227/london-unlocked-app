name: üß™ Mobile Test Automation

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - 'london-unlocked/**'
      - 'london-unlocked-tests/**'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'london-unlocked/**'
      - 'london-unlocked-tests/**'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'sanity'
        type: choice
        options:
          - sanity
          - smoke
          - regression
          - auth
          - explore
          - e2e
          - all
      build_apk:
        description: 'Build fresh APK'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '11'
  API_LEVEL: 30
  ARCH: x86_64
  TARGET: google_apis

jobs:
  code-quality:
    name: üîç Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            london-unlocked/package-lock.json
            london-unlocked-tests/package-lock.json

      - name: üì¶ Install test dependencies
        working-directory: london-unlocked-tests
        run: npm ci

      - name: üîç Run ESLint
        working-directory: london-unlocked-tests
        run: npm run lint || echo "‚ö†Ô∏è  Linting warnings found"
        continue-on-error: true

      - name: üîç TypeScript compilation check
        working-directory: london-unlocked-tests
        run: npx tsc --noEmit

  build-app:
    name: üî® Build Android APK
    runs-on: ubuntu-latest
    needs: code-quality
    if: github.event.inputs.build_apk != 'false'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: london-unlocked/package-lock.json

      - name: ‚òï Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: üì¶ Install app dependencies
        working-directory: london-unlocked
        run: npm install --legacy-peer-deps

      - name: üî® Build APK
        working-directory: london-unlocked/android
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug --no-daemon

      - name: üì§ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: london-unlocked/android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

  test-android:
    name: üß™ Run Tests on Android
    runs-on: ubuntu-latest
    needs: build-app
    if: always() && (needs.build-app.result == 'success' || needs.build-app.result == 'skipped')

    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - ${{ github.event.inputs.test_suite || 'sanity' }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: london-unlocked-tests/package-lock.json

      - name: ‚òï Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: üì± Enable KVM (for Android Emulator)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: üì• Download APK
        uses: actions/download-artifact@v4
        with:
          name: app-debug-apk
          path: london-unlocked/android/app/build/outputs/apk/debug/
        continue-on-error: true

      - name: üì¶ Install test dependencies
        working-directory: london-unlocked-tests
        run: npm ci

      - name: üîß Install Appium
        run: |
          npm install -g appium@latest
          appium driver install uiautomator2
          appium --version

      - name: üì± Setup Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.API_LEVEL }}
          target: ${{ env.TARGET }}
          arch: ${{ env.ARCH }}
          profile: Nexus 6
          ram-size: 2048M
          heap-size: 512M
          disk-size: 8192M
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          force-avd-creation: false
          script: |
            echo "‚úÖ Emulator started"
            adb devices
            
            # Install app
            adb install -r london-unlocked/android/app/build/outputs/apk/debug/app-debug.apk
            
            # Wait for app installation
            sleep 5
            
            # Start Appium server in background
            appium --address 127.0.0.1 --port 4723 --log /tmp/appium.log > /dev/null 2>&1 &
            APPIUM_PID=$!
            sleep 10
            
            # Check if Appium is running
            if ps -p $APPIUM_PID > /dev/null; then
              echo "‚úÖ Appium server started (PID: $APPIUM_PID)"
            else
              echo "‚ùå Appium failed to start"
              cat /tmp/appium.log
              exit 1
            fi
            
            # Run tests
            cd london-unlocked-tests
            
            case "${{ matrix.test-suite }}" in
              sanity)
                npm run test:sanity
                ;;
              smoke)
                npm run wdio -- --suite smoke
                ;;
              regression)
                npm run wdio -- --suite regression
                ;;
              auth)
                npm run wdio -- --suite auth
                ;;
              explore)
                npm run wdio -- --suite explore
                ;;
              e2e)
                npm run wdio -- --suite e2e
                ;;
              all)
                npm test
                ;;
              *)
                npm test
                ;;
            esac
            
            TEST_EXIT_CODE=$?
            
            # Stop Appium
            kill $APPIUM_PID || true
            
            exit $TEST_EXIT_CODE

      - name: üìä Generate Allure Report
        if: always()
        working-directory: london-unlocked-tests
        run: |
          npm run allure:generate || echo "Failed to generate report"
        continue-on-error: true

      - name: üì§ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-suite }}
          path: london-unlocked-tests/reports/
          retention-days: 30

      - name: üì∏ Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-screenshots-${{ matrix.test-suite }}
          path: london-unlocked-tests/reports/screenshots/
          retention-days: 30

      - name: üìã Upload Appium Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: appium-logs-${{ matrix.test-suite }}
          path: /tmp/appium.log
          retention-days: 7

  publish-report:
    name: üìä Publish Test Report
    runs-on: ubuntu-latest
    needs: test-android
    if: always()

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì• Download test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: allure-results
          merge-multiple: true

      - name: üìä Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results/allure-results
          allure_history: allure-history
          keep_reports: 20

      - name: üöÄ Deploy report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

  notify:
    name: üìß Send Notifications
    runs-on: ubuntu-latest
    needs: [test-android]
    if: always()

    steps:
      - name: üìä Test Summary
        run: |
          echo "## üß™ Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Suite:** ${{ github.event.inputs.test_suite || 'sanity' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ needs.test-android.result }}" >> $GITHUB_STEP_SUMMARY

      - name: ‚úÖ Success notification
        if: needs.test-android.result == 'success'
        run: |
          echo "‚úÖ All tests passed!"
          echo "View detailed report: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: ‚ùå Failure notification
        if: needs.test-android.result == 'failure'
        run: |
          echo "‚ùå Tests failed!"
          echo "View detailed report: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

